sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageToast"],function(e,t,s,n,l,i,r,o){"use strict";return e.extend("knpltsiiasuser.knpltsiias.controller.List",{onInit:async function(){console.log("Application Started");var e={ID:await this._newUserID(),FIRST_NAME:null,LAST_NAME:null,EMAIL:null,PROFILE_IMAGE:null,IS_ARCHIVED:0,CREATED_AT:null,UPDATED_AT:null,APP_VERSION:null,LAST_LOGIN_AT:null,EMPLOYEE_CODE:null,ZONE:null,DESIGNATION:null,MANAGER:null,MOBILE:null,DIVISION_IDENTIFIER:null,IS_ACTIVATED:0};var t={ID:await this._newUserSalesGroupID(),UserID:null,SalesGroup:null,IsArchived:0,CreatedAt:null,UpdatedAt:null};this._oNewIASUser={familyName:null,givenName:null,userName:null,active:null,email:null,phoneNumber:null};console.log(JSON.stringify(this._oNewIASUser));var s=new r(e);this.getView().setModel(s,"newUser");var n=new r(t);this.getView().setModel(n,"newSalesGroup");this._bDescendingSort=false},onLiveSearch:function(e){const n=[];let l=e.getParameter("newValue");if(l){const e=new t("FIRST_NAME",s.Contains,l);n.push(e);if(!isNaN(l)&&l.trim()!==""){const e=new t("ID",s.EQ,Number(l));n.push(e)}}const i=new t({filters:n,and:false});const r=this.byId("usersTable");const o=r.getBinding("items");o.filter(i)},onSort:function(){this._bDescendingSort=!this._bDescendingSort;const e=this.getView().byId("usersTable"),t=e.getBinding("items"),s=new n("ID",this._bDescendingSort);t.sort(s)},onAdd:function(){if(!this.rDialog){this.rDialog=i.load({id:this.getView().getId(),name:"knpltsiiasuser.knpltsiias.fragments.register",controller:this}).then(e=>{this.getView().addDependent(e);return e})}this.rDialog.then(e=>e.open())},onSubmit:function(){const e=this.getView().getModel("newUser");const t=e.getData();const s=this.getView().getModel("newSalesGroup");const n=s.getData();if(t.FIRST_NAME&&t.EMAIL&&t.LAST_NAME&&n.SalesGroup){t.CREATED_AT=this._getCurrentTime();n.CreatedAt=this._getCurrentTime();this._oNewIASUser.givenName=t.FIRST_NAME;this._oNewIASUser.familyName=t.LAST_NAME;this._oNewIASUser.userName=`${t.FIRST_NAME} ${t.LAST_NAME}`;this._oNewIASUser.email=t.EMAIL;this._oNewIASUser.phoneNumber=t.MOBILE;this._oNewIASUser.active=t.IS_ACTIVATED?true:false;if(this._validateNewUserData(t)){console.log("Validations passed");this._checkUserExistence("EMAIL",t.EMAIL);console.log(this._oNewIASUser);console.log(t)}}else{l.error("Please fill in all required fields.")}},onCancel:function(){this.byId("registerDialog").close()},onListItemPress:function(e){const t=this.getOwnerComponent().getRouter();const s=this.getOwnerComponent().getHelper().getNextUIState(1);const n=e.getParameter("listItem");const l=n.getBindingContext("USERS_DATA");const i=l.getObject().ID;t.navTo("detail",{layout:s.layout,userID:i},true)},_validateNewUserData:function(e){const t=/^[a-zA-Z0-9+_.-]+@[a-zA-Z0-9.-]+$/;if(!e.EMAIL.match(t)){l.error("Please enter a valid email");return false}if(e.MOBILE.length!==10){l.error("Please enter a valid mobile number");return false}return true},_checkUserExistence:function(e,t){let s=this.getOwnerComponent().getModel("USERS_DATA").getServiceUrl();s=`${s}User?$filter=${e} eq '${t}'`;$.ajax({url:s,type:"GET",contentType:"application/json",success:e=>this._validateUserExistence(e.value,t),error:function(){l.error("Error retrieving data")}})},_validateUserExistence:async function(e,t){if(e.length===1){l.warning("Email is already registered")}else{const e=await this._checkIASUser(t);if(e){l.warning("Email is already registered in IAS")}else{l.success("Registering new user",{title:"Add user",onClose:this._onRegisterUser.bind(this)})}}},_onRegisterUser:async function(){console.log("Successfully registered");const e=this.getView().getModel("newUser");const t=this.getView().getModel("newSalesGroup");const s=e.getData();const n=t.getData();n.UserID=s.ID;n.SalesGroup=this._formatSalesGroupID(n.SalesGroup);console.log(n,s);await this._createUserInDatabase(s,n);e.setData({ID:await this._newUserID(),FIRST_NAME:null,LAST_NAME:null,EMAIL:null,PROFILE_IMAGE:null,IS_ARCHIVED:0,CREATED_AT:null,UPDATED_AT:null,APP_VERSION:null,LAST_LOGIN_AT:null,EMPLOYEE_CODE:null,ZONE:null,DESIGNATION:null,MANAGER:null,MOBILE:null,DIVISION_IDENTIFIER:null,IS_ACTIVATED:0});t.setData({ID:await this._newUserSalesGroupID(),UserID:null,SalesGroup:null,IsArchived:0,CreatedAt:null,UpdatedAt:null});this._oNewIASUser={familyName:null,givenName:null,userName:null,active:null,email:null,phoneNumber:null};this.onCancel()},_checkIASUser:async function(e){this.showBusyDialog();const t=this.getOwnerComponent().getModel("USERS_DATA").getServiceUrl();const s={email:e};let n=false;await $.ajax({url:`${t}findMyUser`,type:"POST",data:JSON.stringify(s),contentType:"application/json",success:function(e){if(e.value.Resources){console.log("Email already registered in IAS");n=true}},error:function(){l.error("Error")},complete:this.hideBusyDialog.bind(this)});return n},_createUserInDatabase:async function(e,t){let s=this.getOwnerComponent().getModel("USERS_DATA").getServiceUrl();await $.ajax({url:`${s}User`,method:"POST",data:JSON.stringify(e),contentType:"application/json"});o.show("User Saved Successfully");await this._createUserSalesGroupInDatabase(t);await this._createIASUser();this.onPostSuccess()},_createUserSalesGroupInDatabase:function(e){let t=this.getOwnerComponent().getModel("USERS_DATA").getServiceUrl();let s=this;$.ajax({url:`${t}UserSalesGroup`,method:"POST",data:JSON.stringify(e),contentType:"application/json",success:function(e){o.show("User Sales Group Saved Successfully")}.bind(this),error:function(e){console.log(e.responseJSON.error.message)}})},_createIASUser:function(){let e=this.getOwnerComponent().getModel("USERS_DATA").getServiceUrl();let t=this;$.ajax({url:`${e}addMyUser`,method:"POST",data:JSON.stringify(t._oNewIASUser),contentType:"application/json",success:function(e){console.log(e.value);if(e.value.status==="Success"){o.show(e.value.message);return}l.error(e.value.message)}.bind(this),error:function(e){console.log(e.responseJSON.error.message)}})},_getCurrentTime:function(){const e=new Date;const t=e.toISOString();return t},_formatSalesGroupID:function(e){console.log(e.length,typeof e,e);let t;if(e.length===1){t="00"+e}else if(e.length===2){t="0"+e}else{t=e}return t},_newUserID:async function(){let e;let t=this.getOwnerComponent().getModel("USERS_DATA").getServiceUrl();t=`${t}User?$orderby=ID desc&$top=1`;await $.ajax({url:t,method:"GET",success:function(t){e=t.value[0].ID+1},error:function(e){console.log(e)}});console.log(e);return e},_newUserSalesGroupID:async function(){let e;let t=this.getOwnerComponent().getModel("USERS_DATA").getServiceUrl();t=`${t}UserSalesGroup?$orderby=ID desc&$top=1`;await $.ajax({url:t,method:"GET",success:function(t){e=t.value[0].ID+1},error:function(e){console.log(e)}});return e},showBusyDialog:function(){if(!this._pBusyDialog){this._pBusyDialog=i.load({id:this.getView().getId(),name:"knpltsiiasuser.knpltsiias.fragments.busyDialog",controller:this}).then(e=>{this.getView().addDependent(e);return e})}this._pBusyDialog.then(e=>e.open())},hideBusyDialog:function(){if(this._pBusyDialog){this._pBusyDialog.then(e=>e.close())}},onPostSuccess:function(){var e=this.getView().getModel("USERS_DATA");if(e){e.refresh()}}})});
//# sourceMappingURL=List.controller.js.map